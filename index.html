<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
    />
    <link rel="stylesheet" href="./asset/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="./asset/elementui.js"></script>
  </head>
  <body>
    <div id="root">
      <div class="header">
        <img class="header-img01" src="./asset/header01.png" />
        <img class="header-img02" src="./asset/header01.gif" />
      </div>
      <div id="container">
        <svg id="svg1" style="width: 900; height: 600"></svg>
        <svg id="svg2" style="width: 900; height: 600"></svg>
        <svg id="svg3" style="width: 600; height: 600"></svg>
      </div>
      <div class="buttonGroup">
        <template>
          <el-radio
            @change="handleCountrySelection"
            v-model="countrySelection"
            label="US"
            >United States</el-radio
          >
          <el-radio
            @change="handleCountrySelection"
            v-model="countrySelection"
            label="CN"
            >China</el-radio
          >
          <el-radio
            @change="handleCountrySelection"
            v-model="countrySelection"
            label="TW"
            >Taiwan</el-radio
          >
        </template>
      </div>
      <div id="plotchartsvg"></div>
      <div v-if="showLocationInfoBox" id="locationInfoBox">
        <div>Location：{{locationInfoBoxDataSelected.province}}</div>
        <div>
          Number of Occurrence：{{locationInfoBoxDataSelected?.list?.length}}
        </div>
      </div>
      <div v-if="showPlotChartInfoBox" id="plotInfoBox">
        <div>Year：{{plotInfoBoxDataSelected.year}}</div>
        <div>Number：{{plotInfoBoxDataSelected.number}}</div>
        <div>
          Number of Occurrence：{{plotInfoBoxDataSelected?.list?.length}}
        </div>
        <div>
          Month：
          <div v-for="item in plotInfoBoxDataSelected?.list" :key="item">
            {{item}}
          </div>
        </div>
      </div>
      <div class="bottom-container">
        <el-card class="box-card">
          <img style="width: 500px" src="./asset/powerball.png" />
          <div>Lottery Simulator ({{countrySelection}})</div>
          <div style="font-size: 30px; color: gray">
            Please insert six numbers to see how lucky you are. The result would
            tell you how much you might win compared to the history.
          </div>
          <div v-if="countrySelection === 'TW'">
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num01"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num02"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num03"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num04"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num05"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num06"
              placeholder=""
            ></el-input>
            <el-button @click="handleBacktest" type="success" plain
              >Try</el-button
            >
          </div>
          <div v-if="countrySelection === 'US'">
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num01"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num02"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num03"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num04"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num05"
              placeholder=""
            ></el-input>
            <el-input
              style="border: 1px solid red"
              maxlength="2"
              class="inputNum"
              v-model="num06"
              placeholder=""
            ></el-input>
            <el-button @click="handleBacktest" type="success" plain
              >Try</el-button
            >
          </div>
          <div v-if="countrySelection === 'CN'">
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num01"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num02"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num03"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num04"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num05"
              placeholder=""
            ></el-input>
            <el-input
              maxlength="2"
              class="inputNum"
              v-model="num06"
              placeholder=""
            ></el-input>
            <el-input
              style="border: 1px solid red"
              maxlength="2"
              class="inputNum"
              v-model="num07"
              placeholder=""
            ></el-input>
            <el-button @click="handleBacktest" type="success" plain
              >Try</el-button
            >
          </div>
          <div class="prizeContainer">
            <template>
              <el-table :data="tableData" style="width: 100%">
                <el-table-column prop="year" label="Date" width="180">
                </el-table-column>
                <el-table-column prop="isWinning" label="Prize" width="180">
                </el-table-column>
                <el-table-column prop="winningNumber" label="Detail">
                </el-table-column>
              </el-table>
            </template>
          </div>
        </el-card>
        <div id="hint-container"></div>
      </div>
    </div>
  </body>
  <script>
    const app = new Vue({
      el: "#root",
      created: async function () {
        this.resetMap();
        this.usLotteryChartData = await this.processUSData();
        this.twLotteryChartData = await this.processTWData();
        this.cnLotteryChartData = await this.processCNData();
        this.renderPlotChart();

        this.typeWriter();
      },
      data: {
        checkList: ["United States", "China", "Taiwan"],
        twLotteryChartData: "",
        usLotteryChartData: "",
        cnLotteryChartData: "",
        twhistoryPrizeInfo: [],
        ushistoryPrizeInfo: [],
        cnhistoryPrizeInfo: [],
        twplotInfoBoxData: "",
        usplotInfoBoxData: "",
        cnplotInfoBoxData: "",
        countrySelection: "US",
        num01: "",
        num02: "",
        num03: "",
        num04: "",
        num05: "",
        num06: "",
        num07: "",
        tableData: [],
        plotInfoBoxDataSelected: "",
        showPlotChartInfoBox: false,
        locationInfoBoxData: "",
        locationInfoBoxDataSelected: "",
        showLocationInfoBox: false,
        typingTimeout: "",
      },
      computed: {
        numberGroupTW() {
          return [
            this.num01,
            this.num02,
            this.num03,
            this.num04,
            this.num05,
            this.num06,
          ];
        },
        numberGroupUS() {
          return [
            this.num01,
            this.num02,
            this.num03,
            this.num04,
            this.num05,
            this.num06,
          ];
        },
        numberGroupCN() {
          return [
            this.num01,
            this.num02,
            this.num03,
            this.num04,
            this.num05,
            this.num06,
            this.num07,
          ];
        },
      },
      methods: {
        handleCountrySelection() {
          this.renderPlotChart();
        },
        typeWriter() {
          const context = this;
          if (this.typingTimeout) {
            clearTimeout(this.typingTimeout);
          }
          document.getElementById("hint-container").innerHTML = "";
          var i = 0;
          var txt = `
                      It is only 0.001% to
                      win this fortune. Lottery is essentially a type of Gambling.
                      Please use your money carefully. As it shows in some of the
                      social studies, people with financial problems, especially in
                      the pendemic period, are tend to be addicted to small gambling
                      like Lottery. They would: · gamble regardless of their financial
                      situation and that of their families · become heavily indebted,
                      resulting in family problems (including child abuse and suicide)
                      · sometimes connect with gangs, usury and other social problems. 
                      US: https://www.megamillions.com/jackpot-history; 
                      CN: http://www.cwl.gov.cn/kjxx/ssq/kjgg/; 
                      TW: taiwanlottery.com.tw/lotto/lotto649/history.aspx`; /* The text */
          var speed = 50; /* The speed/duration of the effect in milliseconds */
          function doTyping() {
            if (i < txt.length) {
              document.getElementById("hint-container").innerHTML += txt.charAt(
                i
              );
              i++;
              context.typingTimeout = setTimeout(doTyping, speed);
            }
          }
          doTyping();
        },
        handleCloseInfoBox() {
          this.showPlotChartInfoBox = false;
        },
        handleBacktest() {
          this.tableData = [];
          const c = [];
          if (this.countrySelection === "US") {
            if ( // https://www.megamillions.com/How-to-Play.aspx
                 // 更早之前球號有到 75
              this.numberGroupUS.filter((num) => num && num >= 0 && num <= 70)
                .length < 6
            ) {
              alert(
                "The number is incomplete, and the number must between 1 - 70."
              );
              return;
            }
            if (new Set(this.numberGroupUS).size < 6) {
              alert("Number Duplicate.");
              return;
            }
            this.ushistoryPrizeInfo.forEach((period) => {
              const result = compareUSNumber(
                this.numberGroupUS,
                period.numberArray,
                period.year,
                period.specialNum
              );
              if (result.isWinning !== "Not winning.") {
                c.push(result);
                this.tableData = c;
              }
            });
          } else if (this.countrySelection === "CN") {
            if ( // http://sports.sina.com.cn/l/rule/ssq/
              this.numberGroupCN.filter((num) => num && num >= 0 && num <= 33)
                .length < 7
            ) {
              alert(
                "The number is incomplete, and the number must between 1 - 33."
              );
              return;
            }
            if (new Set(this.numberGroupCN).size < 7) {
              alert("Number Duplicate.");
              return;
            }
            this.cnhistoryPrizeInfo.forEach((period) => {
              const result = compareCNNumber(
                this.numberGroupCN,
                period.numberArray,
                period.year,
                period.specialNum
              );
              if (result.isWinning !== "Not winning.") {
                c.push(result);
                this.tableData = c;
              }
            });
          } else {
            if (
              this.numberGroupTW.filter((num) => num && num >= 0 && num <= 49)
                .length < 6
            ) {
              alert(
                "The number is incomplete, and the number must between 1 - 49."
              );
              return;
            }
            if (new Set(this.numberGroupTW).size < 6) {
              alert("Number Duplicate.");
              return;
            }
            this.twhistoryPrizeInfo.forEach((period) => {
              const result = compareTWNumber(
                this.numberGroupTW,
                period.numberArray,
                period.year
              );
              if (result.isWinning !== "Not winning.") {
                c.push(result);
                this.tableData = c;
              }
            });
          }
          this.typeWriter();
        },
        async processUSData() {
          const numInfo = {};
          const numInfoDetail = {};
          const chartNumInfo = [];
          const data = await d3.csv("./data/us/number.csv");
          data.forEach((ele) => {
            const year = ele.year.slice(6, 10);
            const numberArray = ele.numbers.split(" - ");
            // 中獎回測資料
            this.ushistoryPrizeInfo.push({
              numberArray,
              specialNum: ele.specialNumber,
              year: ele.year,
            });
            // 圖表資料
            numberArray.forEach((num) => {
              // 記錄開出次數
              if (!numInfo[year]) {
                numInfo[year] = {};
              }
              if (!numInfo[year][num]) {
                numInfo[year][num] = 0;
              }
              numInfo[year][num] += 1;
              // 記錄開出月份
              if (!numInfoDetail[year]) {
                numInfoDetail[year] = {};
              }
              if (!numInfoDetail[year][num]) {
                numInfoDetail[year][num] = [];
              }
              numInfoDetail[year][num].push(ele.year);
            });
          });
          delete numInfo[""];
          delete numInfoDetail[""];
          this.usplotInfoBoxData = numInfoDetail;
          Object.keys(numInfo).forEach((year) => {
            Object.keys(numInfo[year]).forEach((number) => {
              chartNumInfo.push({
                year,
                number,
                count: numInfo[year][number],
              });
            });
          });
          return chartNumInfo;
        },
        async processCNData() {
          const numInfo = {};
          const numInfoDetail = {};
          const chartNumInfo = [];
          const data = await d3.csv("./data/cn/number.csv");
          data.forEach((ele) => {
            const year = ele["开奖日期"].slice(0, 4);
            let numberArray = ele["红球"].match(/.{1,2}/g);
            // 中獎回測資料
            this.cnhistoryPrizeInfo.push({
              numberArray,
              specialNum: ele["蓝球"],
              year: ele["开奖日期"],
            });
            // 圖表資料
            numberArray.forEach((num) => {
              // 記錄開出次數
              if (!numInfo[year]) {
                numInfo[year] = {};
              }
              if (!numInfo[year][num]) {
                numInfo[year][num] = 0;
              }
              numInfo[year][num] += 1;
              // 記錄開出月份
              if (!numInfoDetail[year]) {
                numInfoDetail[year] = {};
              }
              if (!numInfoDetail[year][num]) {
                numInfoDetail[year][num] = [];
              }
              numInfoDetail[year][num].push(ele["开奖日期"]);
            });
          });
          this.cnplotInfoBoxData = numInfoDetail;
          Object.keys(numInfo).forEach((year) => {
            Object.keys(numInfo[year]).forEach((number) => {
              chartNumInfo.push({
                year,
                number,
                count: numInfo[year][number],
              });
            });
          });
          return chartNumInfo;
        },
        async processTWData() {
          const numInfo = {};
          const numInfoDetail = {};
          const chartNumInfo = [];
          const data = await d3.csv("./data/tw/tw-number.csv");
          data.forEach((ele) => {
            const year = ele.year.slice(0, 4);
            let numberArray = ele.numbers.match(/.{1,2}/g);
            // 中獎回測資料
            this.twhistoryPrizeInfo.push({
              numberArray,
              specialNum: numberArray[6],
              year: ele.year,
            });
            // 圖表資料
            numberArray.forEach((num) => {
              // 記錄開出次數
              if (!numInfo[year]) {
                numInfo[year] = {};
              }
              if (!numInfo[year][num]) {
                numInfo[year][num] = 0;
              }
              numInfo[year][num] += 1;
              // 記錄開出月份
              if (!numInfoDetail[year]) {
                numInfoDetail[year] = {};
              }
              if (!numInfoDetail[year][num]) {
                numInfoDetail[year][num] = [];
              }
              numInfoDetail[year][num].push(ele.year);
            });
          });
          this.twplotInfoBoxData = numInfoDetail;
          Object.keys(numInfo).forEach((year) => {
            Object.keys(numInfo[year]).forEach((number) => {
              chartNumInfo.push({
                year,
                number,
                count: numInfo[year][number],
              });
            });
          });
          return chartNumInfo;
        },
        async renderUSMap({ scale }) {
          var width = 1200;
          var height = 500;

          // D3 Projection
          var projection = d3
            .geoAlbersUsa()
            .translate([width / 5, height / 2])
            .scale([scale]);

          // Define path generator
          var path = d3
            .geoPath() // path generator that will convert GeoJSON to SVG paths
            .projection(projection); // tell path generator to use albersUsa projection
          const context = this;
          d3.json("./data/us/state.json").then(function (json) {
            const labels = [
              {
                color: "#588c7e",
                text: "< 5",
              },
              {
                color: "#acbc8a",
                text: "< 10",
              },
              {
                color: "#ffcc80",
                text: "< 15",
              },
              {
                color: "#e99469",
                text: "< 20",
              },
              {
                color: "#6573c3",
                text: "< 25",
              },
              {
                color: "#bc5952",
                text: "> 25",
              },
            ];
            const gap = 70;
            labels.forEach((label, i) => {
              d3.select("#svg1")
                .append("rect")
                .attr("x", 30 + gap * i)
                .attr("y", 450)
                .attr("width", 20)
                .attr("height", 20)
                .attr("fill", label.color)
                .attr("id", "rectLabel");
              d3.select("#svg1")
                .append("text")
                .attr("x", 60 + gap * i)
                .attr("y", 465)
                .text(label.text);
            });

            d3.select("#svg1")
              .selectAll("path")
              .data(json.features)
              .enter()
              .append("path")
              .attr("d", path)
              .attr("id", (d) => d.properties.name.replace(/\s/g, ""))
              .style("stroke", "#fff")
              .style("stroke-width", "1")
              .style("fill", "rgb(213,222,217)")
              .on("mouseover", function ({ properties }) {
                context.showLocationInfoBox = true;
                d3.select(this).attr("fill-opacity", 0.6);
                context.locationInfoBoxDataSelected = {
                  province: properties.name,
                  list: new Array(locationData[properties.name]),
                };
              })
              .on("mouseout", function (d) {
                d3.select(this).attr("fill-opacity", 1);
                context.showLocationInfoBox = false;
              });
          });

          const locationData = await d3.json("./data/us/location.json");
          Object.keys(locationData).forEach((state) => {
            d3.select(`#${state.replace(/\s/g, "")}`).style(
              "fill",
              usColorGrade(locationData[state])
            );
          });
        },
        async renderCNMap({ scale }) {
          const context = this;
          var width = 1200;
          var height = 500;

          // D3 Projection
          var projection = d3
            .geoMercator()
            .center([110, 25])
            .scale([scale])
            .translate([width / 4.5, 350])
            .precision([0.1]);

          // Define path generator
          var path = d3
            .geoPath() // path generator that will convert GeoJSON to SVG paths
            .projection(projection); // tell path generator to use albersUsa projection

          //Create SVG element and append map to the SVG

          d3.json("./data/cn/state.json").then(function (json) {
            const labels = [
              {
                color: "#588c7e",
                text: "< 50",
              },
              {
                color: "#acbc8a",
                text: "< 100",
              },
              {
                color: "#ecd189",
                text: "< 150",
              },
              {
                color: "#e99469",
                text: "< 200",
              },
              {
                color: "#6573c3",
                text: "< 250",
              },
              {
                color: "#bc5952",
                text: "> 250",
              },
            ];
            const gap = 80;
            labels.forEach((label, i) => {
              d3.select("#svg2")
                .append("rect")
                .attr("x", 30 + gap * i)
                .attr("y", 450)
                .attr("width", 20)
                .attr("height", 20)
                .attr("fill", label.color)
                .attr("id", "rectLabel");
              d3.select("#svg2")
                .append("text")
                .attr("x", 60 + gap * i)
                .attr("y", 465)
                .text(label.text);
            });

            d3.select("#svg2")
              .selectAll("path")
              .data(json.features)
              .enter()
              .append("path")
              .attr("d", path)
              .attr("id", (d) => d.properties.name)
              .style("stroke", "#fff")
              .style("stroke-width", "1")
              .style("fill", "rgb(213,222,217)")
              .on("mouseover", function ({ properties }) {
                context.showLocationInfoBox = true;
                d3.select(this).attr("fill-opacity", 0.6);
                context.locationInfoBoxDataSelected = {
                  province: properties.name,
                  list: new Array(resultDetail[properties.name]),
                };
              })
              .on("mouseout", function (d) {
                d3.select(this).attr("fill-opacity", 1);
                context.showLocationInfoBox = false;
              });
          });
          const locationData = await d3.csv("./data/cn/location.csv");
          const resultDetail = {};
          const result = locationData.map((d) =>
            d.prizes
              .split(/注/g)
              .map((word) => word.split(/(?=\d)/g))
              .map((item) => {
                if (item.length === 3) {
                  item[1] = item[1] + item[2];
                  item.pop();
                }
                return item;
              })
          );
          result.forEach((_stateData) => {
            _stateData.forEach((stateData) => {
              const province = stateData[0];
              const provinceNum = stateData[1];
              if (resultDetail[province]) {
                resultDetail[province] += Number(provinceNum);
              } else {
                resultDetail[province] = Number(provinceNum);
              }
            });
          });
          String.prototype.regexIndexOf = function (regex, startpos) {
            var indexOf = this.substring(startpos || 0).search(regex);
            return indexOf >= 0 ? indexOf + (startpos || 0) : indexOf;
          };
          Object.keys(resultDetail).forEach((key) => {
            if (key.regexIndexOf(/。|；|�|为|共|null/g) !== -1) {
              delete resultDetail[key];
            }
          });
          Object.keys(resultDetail).forEach((state) => {
            d3.select(`#${state}`).style("fill", () =>
              cnColorGrade(resultDetail[state])
            );
          });
        },
        renderTWMap({ scale }) {
          const context = this;
          d3.json("./data/tw/state.json").then(function (topodata) {
            const labels = [
              {
                color: "#588c7e",
                text: "< 5",
              },
              {
                color: "#acbc8a",
                text: "< 10",
              },
              {
                color: "#ffcc80",
                text: "< 15",
              },
              {
                color: "#bc5952",
                text: "> 20",
              },
            ];
            const gap = 70;
            labels.forEach((label, i) => {
              d3.select("#svg3")
                .append("rect")
                .attr("x", 30 + gap * i)
                .attr("y", 450)
                .attr("width", 20)
                .attr("height", 20)
                .attr("fill", label.color)
                .attr("id", "rectLabel");
              d3.select("#svg3")
                .append("text")
                .attr("x", 60 + gap * i)
                .attr("y", 465)
                .text(label.text);
            });

            const features = topojson.feature(topodata, topodata.objects.county)
              .features;
            const projection = d3
              .geoMercator()
              .center([118, 27])
              .scale([scale])
              .translate([0, 0])
              .precision([0.1]);
            const path = d3.geoPath().projection(projection);
            d3.select("#svg3")
              .selectAll("path")
              .data(features)
              .enter()
              .append("path")
              .attr("d", path)
              .attr("id", ({ properties }) => properties.C_Name)
              .attr("fill", "teal")
              .on("mouseover", function ({ properties }) {
                d3.select(this).attr("fill-opacity", 0.6);
                context.locationInfoBoxDataSelected = {
                  province: properties.C_Name,
                  list: context.locationInfoBoxData[properties.C_Name],
                };
                context.showLocationInfoBox = true;
              })
              .on("mouseout", function (d) {
                d3.select(this).attr("fill-opacity", 1);
                context.showLocationInfoBox = false;
              });
          });
          d3.csv("./data/tw/tw-location.csv").then((data) => {
            const provinceCount = {};
            const detailProvinceCount = {};
            data.forEach((lottery) => {
              const province = lottery["province"];
              if (provinceCount[province]) {
                provinceCount[province] += 1;
              } else {
                provinceCount[province] = 1;
              }

              if (detailProvinceCount[province]) {
                detailProvinceCount[province].push(lottery);
              } else {
                detailProvinceCount[province] = [lottery];
              }
            });
            this.locationInfoBoxData = detailProvinceCount;
            Object.keys(provinceCount).forEach((province) => {
              d3.select(`#${province}`).attr(
                "fill",
                twColorGrade(provinceCount[province])
              );
            });
          });
        },
        resetMap() {
          document.querySelector("#svg1").innerHTML = "";
          document.querySelector("#svg2").innerHTML = "";
          document.querySelector("#svg3").innerHTML = "";
          this.renderUSMap({
            scale: 600,
          });
          this.renderCNMap({
            scale: 400,
          });
          this.renderTWMap({
            scale: 4000,
          });
        },
        renderPlotChart() {
          document.querySelector("#plotchartsvg").innerHTML = "";

          var margin = { top: 10, right: 30, bottom: 40, left: 50 },
            width = 1120 - margin.left - margin.right,
            height = 520 - margin.top - margin.bottom;

          // append the svg object to the body of the page
          var Svg = d3
            .select("#plotchartsvg")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr(
              "transform",
              "translate(" + margin.left + "," + margin.top + ")"
            );

          //Read the data
          d3.csv(
            "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/iris.csv"
          ).then(async (data) => {
            // Add X axis
            if (this.countrySelection === "TW") {
              var x = d3.scaleLinear().domain([0, 50]).range([0, width]);
            } else if (this.countrySelection === "US") {
              var x = d3.scaleLinear().domain([0, 75]).range([0, width]);
            } else {
              var x = d3.scaleLinear().domain([0, 50]).range([0, width]);
            }
            Svg.append("g")
              .attr("transform", "translate(0," + height + ")")
              .call(
                d3
                  .axisBottom(x)
                  .tickSize(-height * 1.3)
                  .ticks(60)
              )
              .select(".domain")
              .remove();

            // Add Y axis
            var y = d3
              .scaleLinear()
              .domain([2003, 2020])
              .range([height, 0])
              .nice();
            Svg.append("g")
              .call(
                d3
                  .axisLeft(y)
                  .tickSize(-width * 1.3)
                  .ticks(20)
              )
              .select(".domain")
              .remove();

            // Customization
            Svg.selectAll(".tick line").attr("stroke", "#EBEBEB");

            // Add X axis label:
            Svg.append("text")
              .attr("text-anchor", "end")
              .attr("x", width + 20)
              .attr("y", height + margin.top + 20)
              .text("Numbers");

            // Y axis label:
            Svg.append("text")
              .attr("text-anchor", "end")
              .attr("transform", "rotate(-90)")
              .attr("y", -margin.left + 10)
              .attr("x", -margin.top)
              .text("Years");

            // Add dots
            const dotGroup = Svg.append("g").attr("id", "dotGroup");
            const context = this;
            dotGroup
              .selectAll("circle")
              .data(
                this.countrySelection === "US"
                  ? this.usLotteryChartData
                  : this.countrySelection === "TW"
                  ? this.twLotteryChartData
                  : this.cnLotteryChartData
              )
              .enter()
              .append("circle")
              .attr("cx", function (d) {
                return x(Number(d.number));
              })
              .attr("cy", function (d) {
                return y(Number(d.year));
              })
              .attr("r", 6)
              .style("fill", (d) =>
                context.countrySelection === "TW"
                  ? twColorGrade(d.count)
                  : cnBallColorGrade(d.count)
              )
              .on("mouseover", function (d) {
                context.showPlotChartInfoBox = true;
                d3.select(this).attr("fill-opacity", 0.6);
                context.plotInfoBoxDataSelected = {
                  number: d.number,
                  year: d.year,
                  list:
                    context.countrySelection === "US"
                      ? context.usplotInfoBoxData[d.year][d.number]
                      : context.countrySelection === "TW"
                      ? context.twplotInfoBoxData[d.year][d.number]
                      : context.cnplotInfoBoxData[d.year][d.number],
                };
              })
              .on("mouseout", function (d) {
                context.showPlotChartInfoBox = false;
                d3.select(this).attr("fill-opacity", 1);
              });
          });
          const labels = [
            {
              color: "#588c7e",
              text: "< 5",
            },
            {
              color: "#acbc8a",
              text: "< 10",
            },
            {
              color: "#ffcc80",
              text: "< 15",
            },
            {
              color: "#e99469",
              text: "< 20",
            },
            {
              color: "#6573c3",
              text: "< 25",
            },
            {
              color: "#bc5952",
              text: "> 25",
            },
          ];
          const gap = 70;
          labels.forEach((label, i) => {
            d3.select("#plotchartsvg svg")
              .append("rect")
              .attr("x", 330 + gap * i)
              .attr("y", 500)
              .attr("width", 10)
              .attr("height", 10)
              .attr("fill", label.color)
              .attr("id", "rectLabel");
            d3.select("#plotchartsvg svg")
              .append("text")
              .attr("x", 350 + gap * i)
              .attr("y", 508.5)
              .attr("font-size", 12)
              .text(label.text);
          });
        },
      },
    });

    const usColorGrade = (count) => {
      if (count <= 5) {
        return "#588c7e";
      }
      if (count < 10) {
        return "#acbc8a";
      }
      if (count < 15) {
        return "#ecd189";
      }
      if (count < 25) {
        return "#6573c3";
      }
      if (count > 25) {
        return "#bc5952";
      }
    };

    const cnColorGrade = (count) => {
      if (count <= 50) {
        return "#588c7e";
      }
      if (count < 100) {
        return "#acbc8a";
      }
      if (count < 150) {
        return "#ecd189";
      }
      if (count < 200) {
        return "#e99469";
      }
      if (count < 250) {
        return "#6573c3";
      }
      if (count > 250) {
        return "#bc5952";
      }
    };
    const cnBallColorGrade = (count) => {
      if (count <= 5) {
        return "#588c7e";
      }
      if (count < 10) {
        return "#acbc8a";
      }
      if (count < 15) {
        return "#ecd189";
      }
      if (count < 20) {
        return "#e99469";
      }
      if (count < 25) {
        return "#6573c3";
      }
      if (count >= 25) {
        return "#bc5952";
      }
    };

    const twColorGrade = (count) => {
      if (count <= 5) {
        return "#588c7e";
      }
      if (count > 5 && count <= 10) {
        return "#acbc8a";
      }
      if (count > 10 && count <= 15) {
        return "#ecd189";
      }
      if (count > 15 && count <= 20) {
        return "#e99469";
      }
      if (count > 20) {
        return "#bc5952";
      }
    };

    function compareTWNumber(array1, array2, year) {
      var result = {};

      array1
        .map((d) => Number(d))
        .forEach(function (item) {
          result[item] = 0;
        });

      array2
        .map((d) => Number(d))
        .forEach(function (item) {
          if (result.hasOwnProperty(item)) {
            result[item]++;
          }
        });
      const matchNumberCount = Object.entries(result)
        .map((arr) => arr[1])
        .reduce((a, b) => a + b);
      const hasSpecial = result[array2[6]] === 1;
      function isWinning() {
        if (matchNumberCount === 3 && hasSpecial) {
          return "Seventh Prize NTD 400";
        }
        if (matchNumberCount === 3 && !hasSpecial) {
          return "General Prize NTD 400";
        }
        if (matchNumberCount === 4 && hasSpecial) {
          return "Sixth Prize NTD 1000";
        }
        if (matchNumberCount === 4 && !hasSpecial) {
          return "Fifth Prize NTD 2000";
        }
        if (matchNumberCount === 5 && hasSpecial) {
          return "Forth Prize Around NTD 10 thousand";
        }
        if (matchNumberCount === 5 && !hasSpecial) {
          return "Third Prize Around NTD 50 thousand";
        }
        if (matchNumberCount === 6 && hasSpecial) {
          return "Second Prize Around NTD 3 Million";
        }
        if (matchNumberCount === 6 && !hasSpecial) {
          return "Jackpot!! Over NTD 100 Million";
        }
        return "Not winning.";
      }

      return {
        winningNumber: JSON.stringify(
          Object.entries(result)
            .filter((d) => d[1] === 1)
            .map((d) => d[0])
        ),
        matchNumberCount,
        specialNum: array2[6],
        hasSpecial,
        isWinning: isWinning(),
        year,
      };
    }

    function compareUSNumber(array1, array2, year, specialNum) {
      var result = {};
      const userSelectionSpecialNum = array1[5];
      array1
        .slice(0, 5)
        .map((d) => Number(d))
        .forEach(function (item) {
          result[item] = 0;
        });

      array2
        .map((d) => Number(d))
        .forEach(function (item) {
          if (result.hasOwnProperty(item)) {
            result[item]++;
          }
        });
      const matchNumberCount = Object.entries(result)
        .map((arr) => arr[1])
        .reduce((a, b) => a + b);
      const hasSpecial = userSelectionSpecialNum === specialNum;
      // matchNumberCount 不包含 special number
      function isWinning() {
        if (matchNumberCount === 0 && hasSpecial) {
          return "General Prize USD $2";
        }
        if (matchNumberCount === 1 && hasSpecial) {
          return "Seventh Prize USD $4";
        }
        if (matchNumberCount === 2 && hasSpecial) {
          return "Sixth Prize USD $10";
        }
        if (matchNumberCount === 3 && !hasSpecial) {
          return "Fifth Prize USD $10";
        }
        if (matchNumberCount === 3 && hasSpecial) {
          return "Forth Prize Around USD $200";
        }
        if (matchNumberCount === 4 && !hasSpecial) {
          return "Third Prize Around USD $500";
        }
        if (matchNumberCount === 5 && hasSpecial) {
          return "Jackpot!! Over USD $1,000,000,00 up";
        }
        if (matchNumberCount === 5 && !hasSpecial) {
          return "Second Prize Around USD $1,000,000";
        }
        return "Not winning.";
      }

      return {
        winningNumber:
          matchNumberCount === 0 && hasSpecial
            ? JSON.stringify([specialNum]) // 只中特別號時
            : JSON.stringify(
                Object.entries(result)
                  .filter((d) => d[1] === 1)
                  .map((d) => d[0])
              ),
        matchNumberCount,
        specialNum: array2[6],
        hasSpecial,
        isWinning: isWinning(),
        year,
      };
    }

    function compareCNNumber(array1, array2, year, specialNum) {
      var result = {};
      const userSelectionSpecialNum = array1[6];
      array1
        .slice(0, 6)
        .map((d) => Number(d))
        .forEach(function (item) {
          result[item] = 0;
        });

      array2
        .map((d) => Number(d))
        .forEach(function (item) {
          if (result.hasOwnProperty(item)) {
            result[item]++;
          }
        });
      const matchNumberCount = Object.entries(result)
        .map((arr) => arr[1])
        .reduce((a, b) => a + b);
      const hasSpecial = userSelectionSpecialNum === specialNum;
      function isWinning() {
        if (matchNumberCount === 0 && hasSpecial) {
          return "Seventh Prize CNY $5";
        }
        if (matchNumberCount === 1 && hasSpecial) {
          return "Seventh Prize CNY $5";
        }
        if (matchNumberCount === 2 && hasSpecial) {
          return "Seventh Prize CNY $5";
        }
        if (matchNumberCount === 3 && hasSpecial) {
          return "General Prize CNY $10";
        }
        if (matchNumberCount === 4 && !hasSpecial) {
          return "Sixth Prize CNY $10";
        }
        if (matchNumberCount === 4 && hasSpecial) {
          return "Fifth Prize CNY $200";
        }
        if (matchNumberCount === 5 && !hasSpecial) {
          return "Forth Prize Around CNY $200";
        }
        if (matchNumberCount === 5 && hasSpecial) {
          return "Third Prize Around CNY $3000";
        }
        if (matchNumberCount === 6 && hasSpecial) {
          return "Jackpot!! Over CNY $1 billion";
        }
        if (matchNumberCount === 6 && !hasSpecial) {
          return "Second Prize Around CNY 5 Million";
        }
        return "Not winning.";
      }

      return {
        winningNumber:
          matchNumberCount === 0 && hasSpecial
            ? JSON.stringify([specialNum])
            : JSON.stringify(
                Object.entries(result)
                  .filter((d) => d[1] === 1)
                  .map((d) => d[0])
              ),
        matchNumberCount,
        specialNum: array2[6],
        hasSpecial,
        isWinning: isWinning(),
        year,
      };
    }
  </script>
</html>
